generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id                    String                 @id @default(uuid()) @db.VarChar(36)
  userNo                String                 @unique() @db.VarChar(50)
  name                  String                 @db.VarChar(50)
  password              String                 @db.VarChar(100)
  email                 String?
  phone                 String?
  isAdmin               Boolean                @default(false)
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  roles                 Role[]
  extraWorkApplications ExtraWorkApplication[] @relation("userExtraWorkApplications")
}

model Role {
  id          String   @id @default(uuid()) @db.VarChar(36)
  name        String   @unique() @db.VarChar(50)
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  users       User[]
  menus       Menu[]
}

enum MenuType {
  Iframe
  View
  Group
}

model Menu {
  id           String   @id @default(uuid()) @db.VarChar(36)
  name         String   @unique() @db.VarChar(50)
  type         MenuType
  routerPath   String?
  url          String?
  sort         Int?
  isEnabled    Boolean  @default(false)
  description  String?  @db.VarChar(255)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  roles        Role[]
  parentMenuId String?
  parentMenu   Menu?    @relation("parentSubMenu", fields: [parentMenuId], references: [id])
  subMenus     Menu[]   @relation("parentSubMenu")
}

model Table {
  id                  String                @id @default(uuid()) @db.VarChar(36)
  name                String                @unique() @db.VarChar(50)
  tableName           String                @db.VarChar(50)
  description         String?               @db.VarChar(255)
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  cols                Col[]                 @relation("tableCols")
  parentCols          Col[]                 @relation("parentSubTableCols")
  dynamicFormViewComp DynamicFormViewComp[] @relation("dynamicFormViewCompTable")
}

enum ColType {
  String
  Boolean
  Int
  DateTime
  SubTable
}

enum SubTableType {
  ToOne
  ToMany
}

enum SubTableWritableStrategy {
  ConnectById
  UpsertByObject
}

enum SubTableQueryStrategy {
  FullObject
  PartialObject
}

model Col {
  id                       String                    @id @default(uuid()) @db.VarChar(36)
  name                     String                    @db.VarChar(50)
  canWritable              Boolean                   @default(true)
  canQuery                 Boolean                   @default(true)
  colType                  ColType
  subTableType             SubTableType?
  subTableWritableStrategy SubTableWritableStrategy?
  subTableQueryStrategy    SubTableQueryStrategy?
  description              String?                   @db.VarChar(255)
  createdAt                DateTime                  @default(now())
  updatedAt                DateTime                  @updatedAt
  subTable                 Table?                    @relation("parentSubTableCols", fields: [subTableId], references: [id])
  subTableId               String?                   @db.VarChar(36)
  table                    Table                     @relation("tableCols", onDelete: Cascade, fields: [tableId], references: [id])
  tableId                  String                    @db.VarChar(36)
}

model DynamicForm {
  id                  String                @id @default(uuid()) @db.VarChar(36)
  name                String                @db.VarChar(50)
  beforeSubmit        String?               @db.VarChar(255)
  // dynamicFormSchemas DynamicFormSchemas[] @relation("dynamicFormSchemas")
  schemas             Json
  description         String?               @db.VarChar(255)
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  dynamicFormViewComp DynamicFormViewComp[] @relation("dynamicFormViewCompForm")
}

enum DynamicFormViewCompDataSourceType {
  DynamicTable
  // OtherTable
}

enum DynamicFormViewCompFormSourceType {
  DynamicForm
  // OtherForm
}

model DynamicFormViewComp {
  id          String   @id @default(uuid()) @db.VarChar(36)
  name        String   @db.VarChar(50)
  tableColumns     Json
  description String?  @db.VarChar(255)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  dataSourceType DynamicFormViewCompDataSourceType
  //TODO ： 此处仍需添加其他数据源配置，如分页，保存，获取等第三方数据源api
  dynamicTable   Table?                            @relation("dynamicFormViewCompTable", fields: [dynamicTableId], references: [id])
  dynamicTableId String?
  //TODO ： 此处仍需添加其他表单，如、第三方url，通过传入初始化数据及提交接口，实现表单获取保存
  formSourceType DynamicFormViewCompFormSourceType
  dynamicForm    DynamicForm?                      @relation("dynamicFormViewCompForm", fields: [dynamicFormId], references: [id])
  dynamicFormId  String?
}

// model DynamicFormSchemas {
//   id             String               @id @default(uuid()) @db.VarChar(36)
//   name           String               @db.VarChar(50)
//   category       String
//   component      String
//   description    String?              @db.VarChar(255)
//   createdAt      DateTime             @default(now())
//   updatedAt      DateTime             @updatedAt
//   children       DynamicFormSchemas[] @relation("parentChildrenSchemas")
//   parentSchema   DynamicFormSchemas?  @relation("parentChildrenSchemas", onDelete: Cascade, fields: [parentSchemaId], references: [id])
//   parentSchemaId String 
//   dynamicForm   DynamicForm @relation("dynamicFormSchemas", onDelete: Cascade, fields: [dynamicFormId], references: [id])
//   dynamicFormId String      @db.VarChar(36)
// }

enum ExtraWorkApplicationType {
  // 常规加班 
  Regular
  // 节假日加班
  Holiday
  // 紧急加班
  Emergency
  // 调休加班
  Compensatory
}

//TODO:加创建人修改人字段
model ExtraWorkApplication {
  id          String                   @id @default(uuid()) @db.VarChar(36)
  userId      String                   @db.VarChar(36)
  user        User?                    @relation("userExtraWorkApplications", fields: [userId], references: [id])
  type        ExtraWorkApplicationType
  startTime   DateTime
  endTime     DateTime
  duration    Int
  description String?                  @db.VarChar(255)
  createdAt   DateTime                 @default(now())
  updatedAt   DateTime                 @updatedAt
}
